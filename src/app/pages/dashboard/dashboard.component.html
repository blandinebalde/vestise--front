<div class="dashboard-page">
  <div class="container">
    <!-- ADMIN DASHBOARD -->
    <ng-container *ngIf="userRole === 'ADMIN'">
      <!-- Admin Header -->
      <div class="dashboard-header">
        <div class="header-content">
          <h1 class="dashboard-title">ğŸ‘‘ Tableau de bord Administrateur</h1>
          <p class="dashboard-subtitle">Vue d'ensemble de la plateforme Vendit</p>
        </div>
        <a routerLink="/admin" class="btn btn-primary btn-large btn-publish">
          âš™ï¸ Administration complÃ¨te
        </a>
      </div>

      <!-- Admin KPI Cards -->
      <div class="dashboard-stats">
        <div class="stat-card card stat-card-annonces">
          <div class="stat-icon">ğŸ“</div>
          <div class="stat-content">
            <h3>Total Annonces</h3>
            <p class="stat-number">{{ totalAnnoncesGlobal }}</p>
            <p class="stat-label">Annonces sur la plateforme</p>
          </div>
        </div>
        <div class="stat-card card stat-card-pending">
          <div class="stat-icon">â³</div>
          <div class="stat-content">
            <h3>En attente</h3>
            <p class="stat-number">{{ pendingAnnonces }}</p>
            <p class="stat-label">Annonces Ã  valider</p>
          </div>
        </div>
        <div class="stat-card card stat-card-users">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-content">
            <h3>Utilisateurs</h3>
            <p class="stat-number">{{ totalUsersGlobal }}</p>
            <p class="stat-label">{{ totalVendeurs }} vendeurs, {{ totalClients }} clients</p>
          </div>
        </div>
        <div class="stat-card card stat-card-revenue">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-content">
            <h3>Revenus (mois)</h3>
            <p class="stat-number">{{ monthlyRevenue | number }}</p>
            <p class="stat-label">FCFA gÃ©nÃ©rÃ©s ce mois</p>
          </div>
        </div>
      </div>

      <!-- Admin Stats Grid -->
      <div class="admin-stats-grid">
        <div class="stat-box card">
          <h4>ğŸ“Š Statistiques</h4>
          <div class="stat-details">
            <div class="stat-row">
              <span>Annonces approuvÃ©es</span>
              <strong>{{ approvedAnnonces }}</strong>
            </div>
            <div class="stat-row">
              <span>Annonces rejetÃ©es</span>
              <strong>{{ rejectedAnnonces }}</strong>
            </div>
            <div class="stat-row">
              <span>Revenus hebdomadaires</span>
              <strong>{{ weeklyRevenue | number }} FCFA</strong>
            </div>
            <div class="stat-row">
              <span>Revenus quotidiens</span>
              <strong>{{ dailyRevenue | number }} FCFA</strong>
            </div>
          </div>
        </div>

        <div class="stat-box card" *ngIf="topCategories.length > 0">
          <h4>ğŸ† Top CatÃ©gories</h4>
          <div class="category-list">
            <div class="category-item" *ngFor="let cat of topCategories">
              <span class="category-name">{{ cat.name }}</span>
              <span class="category-count">{{ cat.count }} annonces</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Quick Actions -->
      <div class="quick-actions">
        <h3>Actions rapides</h3>
        <div class="actions-grid">
          <a routerLink="/admin" [queryParams]="{tab: 'annonces'}" class="action-card card">
            <div class="action-icon">âœ…</div>
            <h4>Valider les annonces</h4>
            <p>{{ pendingAnnonces }} en attente</p>
          </a>
          <a routerLink="/admin" [queryParams]="{tab: 'users'}" class="action-card card">
            <div class="action-icon">ğŸ‘¥</div>
            <h4>GÃ©rer les utilisateurs</h4>
            <p>{{ totalUsersGlobal }} utilisateurs</p>
          </a>
          <a routerLink="/admin" [queryParams]="{tab: 'tarifs'}" class="action-card card">
            <div class="action-icon">ğŸ’µ</div>
            <h4>GÃ©rer les tarifs</h4>
            <p>{{ tarifs.length }} tarifs actifs</p>
          </a>
          <a routerLink="/admin" [queryParams]="{tab: 'categories'}" class="action-card card">
            <div class="action-icon">ğŸ“</div>
            <h4>GÃ©rer les catÃ©gories</h4>
            <p>Organiser les catÃ©gories</p>
          </a>
        </div>
      </div>
    </ng-container>

    <!-- VENDEUR DASHBOARD -->
    <ng-container *ngIf="userRole === 'VENDEUR'">
      <!-- Vendeur Header -->
      <div class="dashboard-header">
        <div class="header-content">
          <h1 class="dashboard-title">ğŸ“Š Mon Tableau de bord Vendeur</h1>
          <p class="dashboard-subtitle">GÃ©rez vos annonces et suivez vos performances</p>
          <p class="credit-balance" *ngIf="currentUser?.creditBalance != null">
            <strong>CrÃ©dits :</strong> {{ currentUser?.creditBalance }} crÃ©dits
            <a routerLink="/credits" class="link-credits">Acheter des crÃ©dits</a>
          </p>
        </div>
        <div class="header-actions">
          <a routerLink="/credits" class="btn btn-outline btn-large">ğŸ’³ Acheter des crÃ©dits</a>
          <a routerLink="/vendre" class="btn btn-primary btn-large btn-publish">
            â• Publier une annonce
          </a>
        </div>
      </div>

      <!-- Vendeur KPI Cards -->
      <div class="dashboard-stats">
        <div class="stat-card card stat-card-annonces">
          <div class="stat-icon">ğŸ“</div>
          <div class="stat-content">
            <h3>Mes annonces</h3>
            <p class="stat-number">{{ annonces.length }}</p>
            <p class="stat-label">{{ approvedAnnonces }} approuvÃ©es, {{ pendingAnnonces }} en attente</p>
          </div>
        </div>
        <div class="stat-card card stat-card-views">
          <div class="stat-icon">ğŸ‘ï¸</div>
          <div class="stat-content">
            <h3>Vues totales</h3>
            <p class="stat-number">{{ totalViews }}</p>
            <p class="stat-label">Personnes intÃ©ressÃ©es</p>
          </div>
        </div>
        <div class="stat-card card stat-card-contacts">
          <div class="stat-icon">ğŸ’¬</div>
          <div class="stat-content">
            <h3>Contacts reÃ§us</h3>
            <p class="stat-number">{{ totalContacts }}</p>
            <p class="stat-label">Messages reÃ§us</p>
          </div>
        </div>
        <div class="stat-card card stat-card-performance">
          <div class="stat-icon">ğŸ“ˆ</div>
          <div class="stat-content">
            <h3>Taux de contact</h3>
            <p class="stat-number">{{ totalViews > 0 ? ((totalContacts / totalViews) * 100).toFixed(1) : 0 }}%</p>
            <p class="stat-label">Taux de conversion</p>
          </div>
        </div>
      </div>

      <!-- Vendeur Status Overview -->
      <div class="status-overview">
        <div class="status-card card">
          <h4>ğŸ“Š Ã‰tat de mes annonces</h4>
          <div class="status-grid">
            <div class="status-item">
              <span class="status-label">ApprouvÃ©es</span>
              <span class="status-value approved">{{ approvedAnnonces }}</span>
            </div>
            <div class="status-item">
              <span class="status-label">En attente</span>
              <span class="status-value pending">{{ pendingAnnonces }}</span>
            </div>
            <div class="status-item">
              <span class="status-label">RejetÃ©es</span>
              <span class="status-value rejected">{{ rejectedAnnonces }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Publication Types Info (only if no annonces) -->
      <div class="publication-types" *ngIf="annonces.length === 0">
        <div class="section-header">
          <h2>ğŸ’ Choisissez votre type de publication</h2>
          <p class="section-subtitle">SÃ©lectionnez le type qui correspond le mieux Ã  vos besoins</p>
        </div>
        <div class="types-grid">
          <div class="type-card card" *ngFor="let tarif of tarifs">
            <div class="type-header">
              <h4>{{ tarif.typeName }}</h4>
              <span class="type-badge" [ngClass]="'badge-' + getPublicationTypeClass(tarif.typeName)">
                {{ tarif.typeName }}
              </span>
            </div>
            <div class="type-price">{{ tarif.price | number }} FCFA</div>
            <div class="type-duration">â±ï¸ {{ tarif.durationDays }} jours</div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- CLIENT DASHBOARD (panier + historique d'achat) -->
    <ng-container *ngIf="userRole === 'USER'">
      <div class="dashboard-header">
        <div class="header-content">
          <h1 class="dashboard-title">ğŸ‘‹ Bienvenue {{ currentUser?.firstName }} !</h1>
          <p class="dashboard-subtitle" *ngIf="currentUser?.code">Votre code client : <strong>{{ currentUser?.code }}</strong></p>
          <p class="dashboard-subtitle" *ngIf="!currentUser?.code">DÃ©couvrez les annonces et suivez votre panier</p>
        </div>
        <a routerLink="/catalogue" class="btn btn-primary btn-large btn-publish">
          ğŸ›ï¸ Parcourir les annonces
        </a>
      </div>

      <!-- Panier -->
      <div class="section-header">
        <h2>ğŸ›’ Mon panier</h2>
        <p class="section-subtitle">{{ cartItems.length }} article(s) dans le panier</p>
      </div>
      <div class="annonces-grid" *ngIf="cartItems.length > 0">
        <div *ngFor="let annonce of cartItems" class="annonce-card card">
          <div class="annonce-image">
            <img [src]="getImageUrl(annonce.images?.[0] ?? '')" [alt]="annonce.title" *ngIf="annonce.images?.length">
            <div class="no-image" *ngIf="!annonce.images?.length"><span class="no-image-icon">ğŸ“·</span></div>
          </div>
          <div class="annonce-content">
            <h3>{{ annonce.title }}</h3>
            <p class="price">{{ annonce.price | number }} FCFA</p>
            <a [routerLink]="['/produit', annonce.id]" class="btn btn-outline btn-sm">Voir</a>
            <button type="button" class="btn btn-primary btn-sm" (click)="confirmPurchase(annonce.id); $event.stopPropagation()">Confirmer l'achat</button>
            <button type="button" class="btn btn-outline btn-sm" (click)="removeFromCart(annonce.id); $event.stopPropagation()">Retirer du panier</button>
          </div>
        </div>
      </div>
      <p class="empty-hint" *ngIf="cartItems.length === 0">Votre panier est vide. <a routerLink="/catalogue">Parcourir les annonces</a></p>

      <!-- Historique d'achats -->
      <div class="section-header">
        <h2>ğŸ“¦ Historique d'achats</h2>
        <p class="section-subtitle">Annonces que vous avez achetÃ©es</p>
      </div>
      <div class="annonces-grid" *ngIf="myPurchases.length > 0">
        <div *ngFor="let annonce of myPurchases" class="annonce-card card" [routerLink]="['/produit', annonce.id]">
          <div class="annonce-image">
            <img [src]="getImageUrl(annonce.images?.[0] ?? '')" [alt]="annonce.title" *ngIf="annonce.images?.length">
            <div class="no-image" *ngIf="!annonce.images?.length"><span class="no-image-icon">ğŸ“·</span></div>
            <span class="badge badge-sold">Vendue</span>
          </div>
          <div class="annonce-content">
            <h3>{{ annonce.title }}</h3>
            <p class="price">{{ annonce.price | number }} FCFA</p>
          </div>
        </div>
      </div>
      <p class="empty-hint" *ngIf="myPurchases.length === 0">Aucun achat pour le moment.</p>
    </ng-container>

    <!-- MY ANNONCES SECTION (Vendeur & Admin) -->
    <div class="my-annonces" *ngIf="userRole === 'VENDEUR' || userRole === 'ADMIN'">
      <div class="section-header">
        <h2>ğŸ“‹ Mes annonces</h2>
        <p class="section-subtitle" *ngIf="annonces.length > 0">
          {{ annonces.length }} annonce{{ annonces.length > 1 ? 's' : '' }} publiÃ©e{{ annonces.length > 1 ? 's' : '' }}
        </p>
      </div>
      
      <!-- Desktop Table View -->
      <div class="annonces-table" *ngIf="annonces.length > 0">
        <table>
          <thead>
            <tr>
              <th>Photo</th>
              <th>Titre</th>
              <th>Prix</th>
              <th>Type</th>
              <th>Statut</th>
              <th>Vues</th>
              <th>Contacts</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let annonce of annonces" class="table-row">
              <td class="image-cell">
                <div class="table-image-wrapper">
                  <img [src]="getImageUrl(annonce.images[0])" [alt]="annonce.title" 
                       *ngIf="annonce.images.length > 0" class="table-image">
                  <div class="no-image" *ngIf="annonce.images.length === 0">ğŸ“·</div>
                </div>
              </td>
              <td class="title-cell">
                <strong>{{ annonce.title }}</strong>
                <span class="annonce-code-ref" *ngIf="annonce.code">RÃ©f. {{ annonce.code }}</span>
                <span class="location-badge" *ngIf="annonce.location">ğŸ“ {{ annonce.location }}</span>
              </td>
              <td class="price-cell">{{ annonce.price | number }} FCFA</td>
              <td>
                <span class="badge" [ngClass]="'badge-' + getPublicationTypeClass(annonce.publicationType)">
                  {{ getPublicationTypeLabel(annonce.publicationType) }}
                </span>
              </td>
              <td>
                <span class="badge" [ngClass]="'badge-' + annonce.status.toLowerCase()">
                  {{ getStatusLabel(annonce.status) }}
                </span>
              </td>
              <td class="stat-cell">
                <span class="stat-value">ğŸ‘ï¸ {{ annonce.viewCount }}</span>
              </td>
              <td class="stat-cell">
                <span class="stat-value">ğŸ’¬ {{ annonce.contactCount }}</span>
              </td>
              <td class="actions-cell">
                <a [routerLink]="['/produit', annonce.id]" class="btn btn-outline btn-sm">
                  ğŸ‘ï¸ Voir
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Mobile Grid View -->
      <div class="annonces-grid-mobile" *ngIf="annonces.length > 0">
        <div *ngFor="let annonce of annonces" class="annonce-card card">
          <div class="annonce-image">
            <img [src]="getImageUrl(annonce.images[0])" [alt]="annonce.title" 
                 *ngIf="annonce.images.length > 0">
            <div class="no-image" *ngIf="annonce.images.length === 0">
              <span class="no-image-icon">ğŸ“·</span>
              <span>Pas d'image</span>
            </div>
            <span class="badge status-badge" [ngClass]="'badge-' + annonce.status.toLowerCase()">
              {{ getStatusLabel(annonce.status) }}
            </span>
            <span class="badge type-badge-mobile" [ngClass]="'badge-' + getPublicationTypeClass(annonce.publicationType)">
              {{ getPublicationTypeLabel(annonce.publicationType) }}
            </span>
          </div>
          <div class="annonce-content">
            <h3>{{ annonce.title }}</h3>
            <p class="annonce-code-ref" *ngIf="annonce.code">RÃ©f. {{ annonce.code }}</p>
            <p class="location" *ngIf="annonce.location">ğŸ“ {{ annonce.location }}</p>
            <p class="price">{{ annonce.price | number }} FCFA</p>
            <div class="annonce-stats">
              <span class="stat-item">
                <span class="stat-icon-small">ğŸ‘ï¸</span>
                {{ annonce.viewCount }} vues
              </span>
              <span class="stat-item">
                <span class="stat-icon-small">ğŸ’¬</span>
                {{ annonce.contactCount }} contacts
              </span>
            </div>
            <a [routerLink]="['/produit', annonce.id]" class="btn btn-primary btn-sm btn-block">
              Voir l'annonce
            </a>
          </div>
        </div>
      </div>
      
      <!-- Empty State (Vendeur only) -->
      <div class="empty-state" *ngIf="annonces.length === 0 && userRole === 'VENDEUR'">
        <div class="empty-icon">ğŸ“­</div>
        <h3>Aucune annonce pour le moment</h3>
        <p>Commencez Ã  vendre dÃ¨s maintenant en publiant votre premiÃ¨re annonce !</p>
        <a routerLink="/vendre" class="btn btn-primary btn-large">
          â• Publier ma premiÃ¨re annonce
        </a>
      </div>

      <!-- Historique des achats de crÃ©dits (Vendeur) -->
      <div class="section-header">
        <h2>ğŸ’³ Historique des achats de crÃ©dits</h2>
      </div>
      <div class="credit-transactions-table" *ngIf="creditTransactions.length > 0">
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Date</th>
              <th>Montant (FCFA)</th>
              <th>CrÃ©dits</th>
              <th>MÃ©thode</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tx of creditTransactions">
              <td><code>{{ tx.code }}</code></td>
              <td>{{ tx.createdAt | date:'short' }}</td>
              <td>{{ tx.amountFcfa | number }}</td>
              <td>{{ tx.creditsAdded }}</td>
              <td>{{ tx.paymentMethod }}</td>
              <td><span class="badge" [ngClass]="'badge-' + (tx.status ?? '').toLowerCase()">{{ tx.status }}</span></td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="empty-hint" *ngIf="creditTransactions.length === 0">Aucun achat de crÃ©dits pour le moment.</p>
    </div>
  </div>
</div>
