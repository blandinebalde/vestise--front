<div class="create-annonce-page">
  <div class="container">
    <h1>Publier une annonce</h1>
    <p class="page-subtitle">Remplissez les √©tapes ci-dessous. Les champs marqu√©s * sont obligatoires.</p>

    <!-- Stepper -->
    <div class="stepper">
      <div class="step" [class.active]="currentStep >= 1" [class.done]="currentStep > 1">
        <span class="step-num">1</span>
        <span class="step-label">Infos g√©n√©rales</span>
      </div>
      <div class="step-line" [class.done]="currentStep > 1"></div>
      <div class="step" [class.active]="currentStep >= 2" [class.done]="currentStep > 2">
        <span class="step-num">2</span>
        <span class="step-label">Photos</span>
      </div>
      <div class="step-line" [class.done]="currentStep > 2"></div>
      <div class="step" [class.active]="currentStep >= 3">
        <span class="step-num">3</span>
        <span class="step-label">R√©capitulatif</span>
      </div>
    </div>

    <form (ngSubmit)="onSubmit()" class="create-form card">
      <!-- Step 1: Infos g√©n√©rales -->
      <div class="step-content" *ngIf="currentStep === 1">
        <h2 class="step-title">Informations de l'annonce</h2>

        <div class="form-group">
          <label class="form-label">Titre *</label>
          <input type="text" class="form-control" [(ngModel)]="annonce.title" name="title"
                 [class.invalid]="errors.title" maxlength="200" placeholder="Ex: Robe traditionnelle bazin">
          <span class="field-error" *ngIf="errors.title">{{ errors.title }}</span>
          <span class="field-hint">{{ (annonce.title || '').length }}/200</span>
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-control" rows="4" [(ngModel)]="annonce.description" name="description"
                    [class.invalid]="errors.description" maxlength="2000"
                    placeholder="D√©crivez votre article..."></textarea>
          <span class="field-error" *ngIf="errors.description">{{ errors.description }}</span>
          <span class="field-hint">{{ (annonce.description || '').length }}/2000</span>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Prix (FCFA) *</label>
            <input type="number" class="form-control" [(ngModel)]="annonce.price" name="price"
                   min="1" step="1" [class.invalid]="errors.price" placeholder="0">
            <span class="field-error" *ngIf="errors.price">{{ errors.price }}</span>
          </div>
          <div class="form-group">
            <label class="form-label">Cat√©gorie *</label>
            <select class="form-control" [(ngModel)]="annonce.categoryId" name="categoryId"
                    [class.invalid]="errors.categoryId">
              <option [ngValue]="null">‚Äî Choisir ‚Äî</option>
              <option *ngFor="let cat of categories" [ngValue]="cat.id">
                {{ cat.icon }} {{ cat.name }}
              </option>
            </select>
            <span class="field-error" *ngIf="errors.categoryId">{{ errors.categoryId }}</span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Type de publication *</label>
            <select class="form-control" [(ngModel)]="annonce.publicationType" name="publicationType"
                    (ngModelChange)="onPublicationTypeChange()" [class.invalid]="errors.publicationType">
              <option value="">‚Äî Choisir un type ‚Äî</option>
              <option *ngFor="let tarif of tarifs" [value]="tarif.typeName">
                {{ tarif.typeName }} ‚Äî {{ tarif.price | number }} cr√©dits
                ({{ (tarif.durationDays && tarif.durationDays > 0) ? (tarif.durationDays + ' jours') : 'Illimit√©' }})
              </option>
            </select>
            <span class="field-error" *ngIf="errors.publicationType">{{ errors.publicationType }}</span>
            <div class="tarif-info" *ngIf="selectedTarif">
              <small>Co√ªt : <strong>{{ creditCost }} cr√©dits</strong> ‚Äî Dur√©e : {{ (selectedTarif.durationDays && selectedTarif.durationDays > 0) ? (selectedTarif.durationDays + ' jours') : 'Illimit√©' }}</small>
              <small class="balance-info">Votre solde : <strong>{{ creditBalance }} cr√©dits</strong>
                <a routerLink="/credits" *ngIf="!hasEnoughCredits"> ‚Äî Acheter des cr√©dits</a>
              </small>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">√âtat</label>
            <select class="form-control" [(ngModel)]="annonce.condition" name="condition">
              <option value="">S√©lectionner</option>
              <option value="NEUF">Neuf</option>
              <option value="OCCASION">Occasion</option>
              <option value="TRES_BON_ETAT">Tr√®s bon √©tat</option>
              <option value="BON_ETAT">Bon √©tat</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Taille</label>
            <select class="form-control" [(ngModel)]="annonce.size" name="size">
              <option value="">S√©lectionner</option>
              <option value="XS">XS</option>
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="XXL">XXL</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Marque</label>
            <input type="text" class="form-control" [(ngModel)]="annonce.brand" name="brand" placeholder="Optionnel">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Couleur</label>
            <input type="text" class="form-control" [(ngModel)]="annonce.color" name="color" placeholder="Ex: Bleu">
          </div>
          <div class="form-group">
            <label class="form-label">Localisation</label>
            <input type="text" class="form-control" [(ngModel)]="annonce.location" name="location" placeholder="Ex: Dakar">
          </div>
        </div>

        <div class="form-group options-group">
          <label class="form-label">Options</label>
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="annonce.toutDoitPartir" name="toutDoitPartir">
            Tout doit partir (prix r√©duits / lots)
          </label>
          <div class="form-group" *ngIf="annonce.toutDoitPartir">
            <label class="form-label">Prix d'origine (FCFA) ‚Äî affich√© barr√©</label>
            <input type="number" class="form-control" [(ngModel)]="annonce.originalPrice" name="originalPrice" min="0" placeholder="Optionnel">
          </div>
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="annonce.isLot" name="isLot">
            Lot (plusieurs articles vendus ensemble)
          </label>
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="annonce.acceptPaymentOnDelivery" name="acceptPaymentOnDelivery">
            Paiement √† la livraison accept√©
          </label>
        </div>
      </div>

      <!-- Step 2: Photos -->
      <div class="step-content" *ngIf="currentStep === 2">
        <h2 class="step-title">Photos de l'annonce</h2>
        <p class="step-desc">Ajoutez au moins une photo. Formats accept√©s : JPG, PNG, WebP, GIF. Max 5 Mo par fichier.</p>

        <div class="upload-zone" (click)="fileInput.click()" (dragover)="onDragOver($event)" (dragleave)="isDragging = false" (drop)="onDrop($event)"
             [class.dragover]="isDragging" [class.has-files]="photoFiles.length > 0">
          <input #fileInput type="file" accept=".jpg,.jpeg,.png,.webp,.gif" multiple (change)="onFileSelected($event)" hidden>
          <ng-container *ngIf="photoFiles.length === 0">
            <span class="upload-icon">üì∑</span>
            <p>Cliquez ou glissez-d√©posez vos photos ici</p>
            <small>Plusieurs photos possibles</small>
          </ng-container>
          <ng-container *ngIf="photoFiles.length > 0">
            <p class="upload-count">{{ photoFiles.length }} photo(s) s√©lectionn√©e(s)</p>
            <div class="photo-previews">
              <div *ngFor="let f of photoFiles; let i = index" class="photo-preview">
                <img [src]="getPreviewUrl(f)" alt="Preview" *ngIf="getPreviewUrl(f)">
                <span class="photo-name" *ngIf="!getPreviewUrl(f)">{{ f.name }}</span>
                <button type="button" class="btn-remove-photo" (click)="removePhoto(i); $event.stopPropagation()" title="Retirer">√ó</button>
              </div>
            </div>
          </ng-container>
        </div>
        <span class="field-error" *ngIf="errors.photos">{{ errors.photos }}</span>
      </div>

      <!-- Step 3: R√©capitulatif -->
      <div class="step-content" *ngIf="currentStep === 3">
        <h2 class="step-title">R√©capitulatif</h2>
        <p class="step-desc">V√©rifiez les informations avant de publier.</p>

        <div class="recap-grid">
          <div class="recap-item">
            <span class="recap-label">Titre</span>
            <strong>{{ annonce.title || '‚Äî' }}</strong>
          </div>
          <div class="recap-item">
            <span class="recap-label">Prix</span>
            <strong>{{ annonce.price != null ? (annonce.price | number) + ' FCFA' : '‚Äî' }}</strong>
          </div>
          <div class="recap-item">
            <span class="recap-label">Cat√©gorie</span>
            <strong>{{ getCategoryName(annonce.categoryId) || '‚Äî' }}</strong>
          </div>
          <div class="recap-item">
            <span class="recap-label">Type de publication</span>
            <strong>{{ annonce.publicationType || '‚Äî' }} ({{ creditCost }} cr√©dits)</strong>
          </div>
          <div class="recap-item full-width" *ngIf="annonce.description">
            <span class="recap-label">Description</span>
            <p class="recap-desc">{{ annonce.description }}</p>
          </div>
          <div class="recap-item">
            <span class="recap-label">Photos</span>
            <strong>{{ photoFiles.length }} photo(s)</strong>
          </div>
        </div>
        <div class="recap-photos" *ngIf="photoFiles.length > 0">
          <div *ngFor="let f of photoFiles" class="recap-photo">
            <img [src]="getPreviewUrl(f)" alt="Photo" *ngIf="getPreviewUrl(f)">
          </div>
        </div>
      </div>

      <div class="error-message" *ngIf="error">{{ error }}</div>

      <div class="form-actions">
        <button type="button" class="btn btn-outline" *ngIf="currentStep > 1" (click)="prevStep()">
          ‚Üê Retour
        </button>
        <button type="button" class="btn btn-primary" *ngIf="currentStep < 3" (click)="nextStep()">
          Suivant ‚Üí
        </button>
        <button type="submit" class="btn btn-primary" *ngIf="currentStep === 3"
                [disabled]="loading || !hasEnoughCredits">
          {{ loading ? 'Publication...' : 'Publier l\'annonce' }}
        </button>
        <button type="button" class="btn btn-outline" (click)="cancel()">
          Annuler
        </button>
      </div>
    </form>
  </div>
</div>
